---
title: "McQueen Final Project"
date: "2024-11-28"
output:
  html_document:
    theme: sandstone
    toc: true
    toc_float:
      collapsed: false  
      smooth_scroll: true 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


#Load libraries
library(tidyverse)
library(patchwork)
library(ggplot2)
library(bslib)
library(kableExtra)
library(dplyr)

```

# **Background Information**

Sex differences in stroke risk and outcomes are well-established, with women generally experiencing strokes later in life than men and often facing worse long-term recovery. These differences arise from a complex combination of biological, hormonal, and behavioral factors that are not fully understood.

# **Research Question**

*How does the incidence of stroke differ between males and females across various age groups, and what patterns or trends emerge in these differences?*

# **Project Organization**

The /data folder contains data required for the project, and /graphs contains the visualization outputs.

A codebook describing all labels and abbreviations used in this project for data, variables, etc. within this project is located at /codebook.xlsx.

# **Dataset**

## Data Origins

The raw data for this visualization project comes from the Lone Star Stroke Research Consortium as part of the **Women’s Imaging of Stroke Hemodynamics Study** (WISHeS), led by Principal Investigator Dr. Adrienne N. Dula at The University of Texas at Austin. Permission to use this dataset for this project was kindly granted by Dr. Dula. The WISHeS study focuses on exploring sex differences in cerebrovascular and hemodynamic factors to understand their role in stroke outcomes. The dataset includes a comprehensive range of clinical information—such as demographics, medical history, and behavioral risk factors—alongside detailed imaging data, including vascular territories, Circle of Willis variations, and ischemic volumes.

```{r, echo=TRUE}
# Replace 'data/wishes_pro_data_current.csv' with the path to your CSV file
data <- read.csv("data/wishes_pro_data_current.csv") 
```

# **Data Preparation**

## Loading Necessary Packages

```{r Install Packages}
#Load necessary libraries
library(tidyverse)
library(patchwork)
library(ggplot2)
library(bslib)
library(kableExtra)
library(dplyr)
```

## Cleaning Data

The WISHeS dataset is large, containing over 237 variables for 220 participants. For the purpose of this visualization project, we specifically focused on participants' age and sex to simplify the analysis and highlight the patterns and trends in stroke incidence across these factors. By creating a reduced dataset, we were able to concentrate on the most relevant information, making the data more manageable and better suited to the project's objectives. The full process of data cleaning and pre-processing is outlined below.

```{r Clean Data, echo=TRUE}
#Reduce data set to variables of interest
reduced_Wishes_data <- data %>%
  select(patient_id, jc_gender, gs_age)

#Select columns and show the first 5 rows
participant_table <- reduced_Wishes_data %>%
  select(patient_id, gs_age, jc_gender) %>%
  head(n = 5)

```

```{r Summary of Clean Data for RMarkdown display , echo=FALSE}

participant_table %>%
  kbl(
    caption = "Participant Information (First 5 Rows)",
    col.names = c("Participant Number", "Participant Age", "Participant Sex"),
    align = "c" # Center-align all columns
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE # Makes the table span the entire page
  )

```

## Creating Age Groups

The purpose of this project is to examine stroke incidence among males and females across various age groups. To create the age groups for analysis, the dataset's minimum and maximum participant ages were first determined.

```{r Summary Age Table, echo=FALSE, message=FALSE}
#Calculate min and max age
summary_table <- reduced_Wishes_data %>%
  summarize(
    Min_Value = min(gs_age, na.rm = TRUE),
    Max_Value = max(gs_age, na.rm = TRUE)
  )
```

```{r Create styled table to display min and max age on rmarkdown, echo=FALSE}
#Create a styled table to display min and max age
summary_table %>%
  kbl(
    caption = "Summary of Minimum and Maximum Ages",
    col.names = c("Minimum Age", "Maximum Age"),
    align = "c" # Center-align columns
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
  )
```

Based on the min and max age I created appropriate age groups for the initial analysis.

```{r Create Age Groups, echo=TRUE}
reduced_Wishes_data <- reduced_Wishes_data %>%
  mutate(age_group = cut(gs_age, 
                         breaks = c(0, 19, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 100, Inf),  # Define 5-year age group ranges
                         labels = c("0-19", "20-25", "26-30", "31-35", "36-40", "41-45", "46-50", "51-55", "56-60", "61-65", "66-70", "71-75", "76-80", "81-85", "86-90", "91-95", "96-100", "100+"),  # Group labels
                         right = TRUE))  
```

# **Initial Visualizations**

## First Initial Visualization

I first visualized the data using a ggplot bar graph but found that it did not effectively highlight the comparison of male and female stroke incidence.

```{r First Visualization, echo=TRUE}
#First visualization, using a simple bar graph
ggplot(reduced_Wishes_data, aes(x = age_group, fill = factor(jc_gender))) +
  geom_bar(position = "dodge") +
  labs(
    title = "Comparison of Stroke Incidence in Male vs Female by Age Group",
    x = "Age Group",
    y = "Count",
    fill = "Gender"
  ) +
  scale_fill_manual(values = c("#1C3A04", "#7eb200")) +  
  theme_minimal() +  
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

## Second Initail Visualization

I then created a population pyramid using ggplot, which improved the visualization; however, I felt it could be further enhanced by positioning the age groups in the center, rather than on the sides of the y-axis, to make the comparison clearer and more intuitive.

```{r create age_gender_count for second visualization, include=FALSE}
#Count the number of males and females in each age group. This process enables the creation of a side-by-side visual comparison.
age_gender_count <- reduced_Wishes_data %>%
  group_by(age_group, jc_gender) %>%
  summarise(count = n(), .groups = "drop")
```

```{r Second Initial Visualization, echo=TRUE}
#Second visualization, creating a population pyramid
ggplot(age_gender_count, aes(x = count, y = age_group, fill = factor(jc_gender))) +
  geom_bar(data = subset(age_gender_count, jc_gender == 1), 
           aes(x = -count),  # Males will be plotted on the left (negative side)
           stat = "identity", 
           position = "dodge") +  # Side-by-side bars for males and females
  geom_bar(data = subset(age_gender_count, jc_gender == 2), 
           stat = "identity", 
           position = "dodge") +  # Females will be plotted on the right
  scale_fill_manual(values = c("#1C3A04", "#7eb200"), 
                    labels = c("Male", "Female")) +  # Note: Male = 1, Female = 2
  labs(
    title = "Stroke Incidence by Age Group and Gender",
    x = "Number of Stroke Cases",
    y = "Age Group",
    fill = "Gender"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  
```

# **Final Visualization**

For my final visualization, I chose to use the Patchwork package to combine three separate graphs—one for males, one for females, and one for age groups—into a cohesive and easily readable population pyramid. This design effectively compares the number of stroke incidences between males and females across different age groups, providing a clear and intuitive representation of the data.

## Prepare Data for Patchwork

The following section of code prepares, processes, and visualizes the data to compare stroke incidences between males and females across various age groups. First, the data is preprocessed by categorizing ages into defined groups using the cut() function, ensuring non-overlapping ranges, and labeling them (e.g., "0-19", "20-24"). Gender values are recoded from numeric values (1 and 2) to descriptive labels ("Male" and "Female"). Missing values in the age group or gender columns are removed using drop_na().

```{r, echo=TRUE}
# Prepare data with updated age groups
data <- data %>%
  mutate(
    age_group = cut(
      gs_age,
      breaks = c(0, 20, seq(25, 100, by = 5)), # Ensure no overlapping breaks
      labels = c("0-19", "20-24", "25-29", "30-34", "35-39", "40-44", 
                 "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", 
                 "75-79", "80-84", "85-89", "90-94", "95-99"), # Matching labels
      right = FALSE
    ),
    gender = recode(jc_gender, `1` = "Male", `2` = "Female")
  ) %>%
  drop_na(age_group, gender)
```

Next, the data is summarized by counting the number of stroke incidences for each combination of age group and gender. This summarized data is then reshaped with separate columns for male and female counts using pivot_wider(), and male counts are made negative to enable a mirrored visualization in the final plot.

```{r Summarize Data for Final Visualization}
summary_data <- data %>%
  group_by(age_group, gender) %>%
  summarise(count = n(), .groups = 'drop') %>%
  pivot_wider(names_from = gender, values_from = count, values_fill = 0) %>%
  mutate(Male = -Male) # Make male counts negative
```

## Create Individual Plots {.tabset}

The visualization is created using three plots. The first plot displays stroke incidences for males as horizontal bars with a greenish color (#1C3A04), using negative counts to position the bars on the left. The second plot visualizes stroke incidences for females with bars in a lighter green shade (#7eb200) on the right. A third plot is created solely for displaying age group labels, styled with bold text and a void theme to eliminate axes and grids.

### Male Plot

```{r Male Plot}
#Create the male plot
plot_male <- ggplot(summary_data, aes(x = Male, y = age_group)) +
  geom_col(fill = "#1C3A04") +
  scale_x_continuous(labels = abs, breaks = seq(min(summary_data$Male, na.rm = TRUE), 0, by = 2)) +
  labs(x = "Number of Stroke Incidences", y = NULL) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major.y = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 12, color = "#1C3A04") # Set title color
  ) +
  ggtitle("Male")
```

### Female Plot

```{r Female Plot}
#Create the female plot
plot_female <- ggplot(summary_data, aes(x = Female, y = age_group)) +
  geom_col(fill = "#7eb200") +
  scale_x_continuous(breaks = seq(0, max(summary_data$Female, na.rm = TRUE), by = 2)) +
  labs(x = "Number of Stroke Incidences", y = NULL) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major.y = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 12, color = "#7eb200") # Set title color
  ) +
  ggtitle("Female")
```

### Age Group Plot

```{r Age Group Plot}
#Create the age group labels with bold title
plot_labels <- ggplot(summary_data, aes(x = 1, y = age_group, label = age_group)) +
  geom_text() +
  theme_void() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 12, face = "bold") # Make title bold
  ) +
  ggtitle("Age Group")
```

## Combine and Create Final Plot

Finally, the three plots are combined side by side using the plot_layout() function, with the male and female plots on either side of the age group labels. A title and caption are added using plot_annotation() to provide context and credit the data source. The combined plot is displayed, presenting a clear visual comparison of stroke incidences by gender across age groups.

```{r Combine Plots to Create Final Visualization}
combined_plot <- plot_male + plot_labels + plot_female +
  plot_layout(widths = c(4, 1, 4)) +
  plot_annotation(
    title = "Comparing Stroke Incidence Between Males and Females Across Age Groups",
    caption = "Data Source: WISHeS Study",
    theme = theme(
      plot.title = element_text(hjust = 0.5, size = 13, face = "bold"),
      plot.caption = element_text(hjust = 0, size = 10, face = "italic")
    )
  )

# Print Plot
print(combined_plot)
```

# **Interpretation and Future Studies**

Write about conclusions from visualization.

# **References**

**Women’s Imaging of Stroke Hemodynamics Study (WISHeS)**. Led by Principal Investigator Dr. Adrienne N. Dula, The University of Texas at Austin. Supported by the Lone Star Stroke Research Consortium, 2022-2024.
